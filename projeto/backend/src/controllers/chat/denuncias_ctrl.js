const { 
  ForumTemaDenuncia, 
  ForumComentarioDenuncia, 
  ChatDenuncia, 
  User, 
  ForumTema, 
  ForumComentario, 
  ChatMensagem,
  Topico_Area,
  Categoria
} = require('../../database/associations');

// ========================================
// FUN√á√ÉO AUXILIAR PARA TRATAR ERROS DE FORMA CONSISTENTE
// ========================================
const handleError = (res, error, message, statusCode = 500) => {
  console.error(`‚ùå [DENUNCIAS] ${message}:`, error);
  console.error(`‚ùå [DENUNCIAS] Stack trace:`, error.stack);
  
  return res.status(statusCode).json({
    success: false,
    message: message,
    error: process.env.NODE_ENV === 'development' ? error.message : 'Erro interno do servidor',
    ...(process.env.NODE_ENV === 'development' && { stack: error.stack })
  });
};

// ========================================
// OBTER DEN√öNCIAS DE TEMAS DO F√ìRUM
// ========================================
const getForumTemaDenuncias = async (req, res) => {
  try {
    console.log('üìã [DENUNCIAS] Buscando den√∫ncias de temas do f√≥rum...');

    const denuncias = await ForumTemaDenuncia.findAll({
      include: [
        {
          model: User,
          as: 'denunciante',
          attributes: ['id_utilizador', 'nome', 'email', 'foto_perfil'],
          required: false // LEFT JOIN para evitar falhas se utilizador foi deletado
        },
        {
          model: ForumTema,
          as: 'tema',
          required: false, // LEFT JOIN para evitar falhas se tema foi deletado
          include: [
            {
              model: User,
              as: 'utilizador',
              attributes: ['id_utilizador', 'nome', 'email', 'foto_perfil'],
              required: false
            },
            {
              model: Topico_Area,
              as: 'topico',
              attributes: ['id_topico', 'titulo'],
              required: false,
              include: [
                {
                  model: Categoria,
                  as: 'categoria',
                  attributes: ['id_categoria', 'nome'],
                  required: false
                }
              ]
            }
          ]
        }
      ],
      order: [['data_denuncia', 'DESC']]
    });

    // Sanitizar dados para evitar erros com valores null/undefined
    const denunciasSanitizadas = denuncias.map(denuncia => {
      const denunciaJSON = denuncia.toJSON();
      
      // Garantir que denunciante existe
      if (!denunciaJSON.denunciante) {
        denunciaJSON.denunciante = {
          id_utilizador: null,
          nome: 'Utilizador removido',
          email: 'N/A',
          foto_perfil: null
        };
      }
      
      // Garantir que tema existe
      if (!denunciaJSON.tema) {
        denunciaJSON.tema = {
          titulo: 'Tema removido ou indispon√≠vel',
          texto: 'Conte√∫do n√£o dispon√≠vel',
          data_criacao: denunciaJSON.data_denuncia,
          utilizador: {
            nome: 'Utilizador desconhecido'
          },
          topico: {
            titulo: 'T√≥pico desconhecido',
            categoria: {
              nome: 'Categoria desconhecida'
            }
          }
        };
      } else {
        // Garantir subcampos do tema
        if (!denunciaJSON.tema.utilizador) {
          denunciaJSON.tema.utilizador = { nome: 'Utilizador desconhecido' };
        }
        if (!denunciaJSON.tema.topico) {
          denunciaJSON.tema.topico = { 
            titulo: 'T√≥pico desconhecido',
            categoria: { nome: 'Categoria desconhecida' }
          };
        } else if (!denunciaJSON.tema.topico.categoria) {
          denunciaJSON.tema.topico.categoria = { nome: 'Categoria desconhecida' };
        }
      }
      
      return denunciaJSON;
    });

    console.log(`‚úÖ [DENUNCIAS] Encontradas ${denuncias.length} den√∫ncias de temas`);

    res.status(200).json({
      success: true,
      data: denunciasSanitizadas,
      total: denuncias.length,
      timestamp: new Date().toISOString()
    });
    
  } catch (error) {
    handleError(res, error, 'Erro ao buscar den√∫ncias de temas');
  }
};

// ========================================
// OBTER DEN√öNCIAS DE COMENT√ÅRIOS DO F√ìRUM  
// ========================================
const getForumComentarioDenuncias = async (req, res) => {
  try {
    console.log('üìã [DENUNCIAS] Buscando den√∫ncias de coment√°rios do f√≥rum...');

    const denuncias = await ForumComentarioDenuncia.findAll({
      include: [
        {
          model: User,
          as: 'denunciante',
          attributes: ['id_utilizador', 'nome', 'email', 'foto_perfil'],
          required: false
        },
        {
          model: ForumComentario,
          as: 'comentario',
          required: false,
          include: [
            {
              model: User,
              as: 'utilizador',
              attributes: ['id_utilizador', 'nome', 'email', 'foto_perfil'],
              required: false
            },
            {
              model: ForumTema,
              as: 'tema',
              required: false,
              attributes: ['id_tema', 'titulo'],
              include: [
                {
                  model: Topico_Area,
                  as: 'topico',
                  attributes: ['id_topico', 'titulo'],
                  required: false,
                  include: [
                    {
                      model: Categoria,
                      as: 'categoria',
                      attributes: ['id_categoria', 'nome'],
                      required: false
                    }
                  ]
                }
              ]
            }
          ]
        }
      ],
      order: [['data_denuncia', 'DESC']]
    });

    // Sanitizar dados
    const denunciasSanitizadas = denuncias.map(denuncia => {
      const denunciaJSON = denuncia.toJSON();
      
      // Garantir que denunciante existe
      if (!denunciaJSON.denunciante) {
        denunciaJSON.denunciante = {
          id_utilizador: null,
          nome: 'Utilizador removido',
          email: 'N/A',
          foto_perfil: null
        };
      }
      
      // Garantir que coment√°rio existe
      if (!denunciaJSON.comentario) {
        denunciaJSON.comentario = {
          texto: 'Coment√°rio removido ou indispon√≠vel',
          data_criacao: denunciaJSON.data_denuncia,
          utilizador: { nome: 'Utilizador desconhecido' },
          tema: {
            titulo: 'Tema desconhecido',
            topico: {
              titulo: 'T√≥pico desconhecido',
              categoria: { nome: 'Categoria desconhecida' }
            }
          }
        };
      } else {
        // Garantir subcampos do coment√°rio
        if (!denunciaJSON.comentario.utilizador) {
          denunciaJSON.comentario.utilizador = { nome: 'Utilizador desconhecido' };
        }
        if (!denunciaJSON.comentario.tema) {
          denunciaJSON.comentario.tema = {
            titulo: 'Tema desconhecido',
            topico: {
              titulo: 'T√≥pico desconhecido',
              categoria: { nome: 'Categoria desconhecida' }
            }
          };
        } else {
          if (!denunciaJSON.comentario.tema.topico) {
            denunciaJSON.comentario.tema.topico = {
              titulo: 'T√≥pico desconhecido',
              categoria: { nome: 'Categoria desconhecida' }
            };
          } else if (!denunciaJSON.comentario.tema.topico.categoria) {
            denunciaJSON.comentario.tema.topico.categoria = { nome: 'Categoria desconhecida' };
          }
        }
      }
      
      return denunciaJSON;
    });

    console.log(`‚úÖ [DENUNCIAS] Encontradas ${denuncias.length} den√∫ncias de coment√°rios`);

    res.status(200).json({
      success: true,
      data: denunciasSanitizadas,
      total: denuncias.length,
      timestamp: new Date().toISOString()
    });
    
  } catch (error) {
    handleError(res, error, 'Erro ao buscar den√∫ncias de coment√°rios');
  }
};

// ========================================
// OBTER DEN√öNCIAS DE MENSAGENS DE CHAT
// ========================================
const getChatDenuncias = async (req, res) => {
  try {
    console.log('üìã [DENUNCIAS] Buscando den√∫ncias de mensagens de chat...');

    const denuncias = await ChatDenuncia.findAll({
      include: [
        {
          model: User,
          as: 'denunciante',
          attributes: ['id_utilizador', 'nome', 'email', 'foto_perfil'],
          required: false
        },
        {
          model: ChatMensagem,
          as: 'mensagem',
          required: false,
          include: [
            {
              model: User,
              as: 'utilizador',
              attributes: ['id_utilizador', 'nome', 'email', 'foto_perfil'],
              required: false
            },
            {
              model: Topico_Area,
              as: 'topico',
              attributes: ['id_topico', 'titulo'],
              required: false,
              include: [
                {
                  model: Categoria,
                  as: 'categoria',
                  attributes: ['id_categoria', 'nome'],
                  required: false
                }
              ]
            }
          ]
        }
      ],
      order: [['data_denuncia', 'DESC']]
    });

    // Sanitizar dados
    const denunciasSanitizadas = denuncias.map(denuncia => {
      const denunciaJSON = denuncia.toJSON();
      
      // Garantir que denunciante existe
      if (!denunciaJSON.denunciante) {
        denunciaJSON.denunciante = {
          id_utilizador: null,
          nome: 'Utilizador removido',
          email: 'N/A',
          foto_perfil: null
        };
      }
      
      // Garantir que mensagem existe
      if (!denunciaJSON.mensagem) {
        denunciaJSON.mensagem = {
          texto: 'Mensagem removida ou indispon√≠vel',
          data_criacao: denunciaJSON.data_denuncia,
          utilizador: { nome: 'Utilizador desconhecido' },
          topico: {
            titulo: 'T√≥pico desconhecido',
            categoria: { nome: 'Categoria desconhecida' }
          }
        };
      } else {
        // Garantir subcampos da mensagem
        if (!denunciaJSON.mensagem.utilizador) {
          denunciaJSON.mensagem.utilizador = { nome: 'Utilizador desconhecido' };
        }
        if (!denunciaJSON.mensagem.topico) {
          denunciaJSON.mensagem.topico = {
            titulo: 'T√≥pico desconhecido',
            categoria: { nome: 'Categoria desconhecida' }
          };
        } else if (!denunciaJSON.mensagem.topico.categoria) {
          denunciaJSON.mensagem.topico.categoria = { nome: 'Categoria desconhecida' };
        }
      }
      
      return denunciaJSON;
    });

    console.log(`‚úÖ [DENUNCIAS] Encontradas ${denuncias.length} den√∫ncias de chat`);

    res.status(200).json({
      success: true,
      data: denunciasSanitizadas,
      total: denuncias.length,
      timestamp: new Date().toISOString()
    });
    
  } catch (error) {
    handleError(res, error, 'Erro ao buscar den√∫ncias de mensagens de chat');
  }
};

// ========================================
// CRIAR DEN√öNCIA DE TEMA
// ========================================
const criarForumTemaDenuncia = async (req, res) => {
  try {
    const { id_tema, motivo, descricao } = req.body;
    const id_denunciante = req.utilizador.id_utilizador;
    
    console.log(`üìù [DENUNCIAS] Criando den√∫ncia para tema ID: ${id_tema}`);
    
    // Validar dados de entrada
    if (!id_tema || !motivo) {
      return res.status(400).json({
        success: false,
        message: 'ID do tema e motivo s√£o obrigat√≥rios'
      });
    }
    
    // Verificar se o tema existe
    const tema = await ForumTema.findByPk(id_tema);
    if (!tema) {
      return res.status(404).json({
        success: false,
        message: 'Tema n√£o encontrado'
      });
    }
    
    // Verificar se o utilizador j√° denunciou este tema
    const denunciaExistente = await ForumTemaDenuncia.findOne({
      where: { 
        id_tema: id_tema, 
        id_denunciante: id_denunciante 
      }
    });
    
    if (denunciaExistente) {
      return res.status(409).json({
        success: false,
        message: 'J√° denunciou este tema anteriormente'
      });
    }
    
    const denuncia = await ForumTemaDenuncia.create({
      id_tema,
      id_denunciante,
      motivo,
      descricao: descricao || null,
      data_denuncia: new Date(),
      resolvida: false
    });
    
    console.log(`‚úÖ [DENUNCIAS] Den√∫ncia de tema criada com sucesso, ID: ${denuncia.id_denuncia}`);
    
    res.status(201).json({
      success: true,
      message: 'Den√∫ncia criada com sucesso',
      data: denuncia
    });
    
  } catch (error) {
    handleError(res, error, 'Erro ao criar den√∫ncia de tema', 500);
  }
};

// ========================================
// OBTER TEMAS J√Å DENUNCIADOS PELO UTILIZADOR
// ========================================
const getUsuarioDenunciasTemas = async (req, res) => {
  try {
    const id_denunciante = req.utilizador.id_utilizador;
    
    console.log(`üìã [DENUNCIAS] Buscando temas denunciados pelo utilizador ID: ${id_denunciante}`);
    
    const denuncias = await ForumTemaDenuncia.findAll({
      where: { id_denunciante },
      attributes: ['id_tema', 'data_denuncia', 'resolvida'],
      order: [['data_denuncia', 'DESC']]
    });
    
    // Extrair apenas os IDs dos temas
    const temasDenunciados = denuncias.map(d => d.id_tema);
    
    console.log(`‚úÖ [DENUNCIAS] Encontrados ${temasDenunciados.length} temas denunciados pelo utilizador`);
    
    res.status(200).json({
      success: true,
      data: temasDenunciados,
      total: temasDenunciados.length,
      detalhes: denuncias
    });
    
  } catch (error) {
    handleError(res, error, 'Erro ao buscar temas denunciados pelo utilizador');
  }
};

// ========================================
// RESOLVER DEN√öNCIA DE TEMA
// ========================================
const resolverForumTemaDenuncia = async (req, res) => {
  try {
    const { id } = req.params;
    const { acao_tomada } = req.body;
    
    console.log(`üîß [DENUNCIAS] Resolvendo den√∫ncia de tema ID: ${id}`);
    
    if (!acao_tomada || acao_tomada.trim() === '') {
      return res.status(400).json({
        success: false,
        message: 'A a√ß√£o tomada √© obrigat√≥ria'
      });
    }
    
    const denuncia = await ForumTemaDenuncia.findByPk(id);
    
    if (!denuncia) {
      return res.status(404).json({
        success: false,
        message: 'Den√∫ncia n√£o encontrada'
      });
    }
    
    if (denuncia.resolvida) {
      return res.status(400).json({
        success: false,
        message: 'Esta den√∫ncia j√° foi resolvida'
      });
    }
    
    await denuncia.update({
      resolvida: true,
      acao_tomada: acao_tomada.trim(),
      data_resolucao: new Date(),
      resolvida_por: req.utilizador.id_utilizador
    });
    
    console.log(`‚úÖ [DENUNCIAS] Den√∫ncia de tema ID: ${id} resolvida com sucesso`);
    
    res.status(200).json({
      success: true,
      message: 'Den√∫ncia resolvida com sucesso',
      data: denuncia
    });
    
  } catch (error) {
    handleError(res, error, 'Erro ao resolver den√∫ncia de tema');
  }
};

// ========================================
// RESOLVER DEN√öNCIA DE COMENT√ÅRIO
// ========================================
const resolverForumComentarioDenuncia = async (req, res) => {
  try {
    const { id } = req.params;
    const { acao_tomada } = req.body;
    
    console.log(`üîß [DENUNCIAS] Resolvendo den√∫ncia de coment√°rio ID: ${id}`);
    
    if (!acao_tomada || acao_tomada.trim() === '') {
      return res.status(400).json({
        success: false,
        message: 'A a√ß√£o tomada √© obrigat√≥ria'
      });
    }
    
    const denuncia = await ForumComentarioDenuncia.findByPk(id);
    
    if (!denuncia) {
      return res.status(404).json({
        success: false,
        message: 'Den√∫ncia n√£o encontrada'
      });
    }
    
    if (denuncia.resolvida) {
      return res.status(400).json({
        success: false,
        message: 'Esta den√∫ncia j√° foi resolvida'
      });
    }
    
    await denuncia.update({
      resolvida: true,
      acao_tomada: acao_tomada.trim(),
      data_resolucao: new Date(),
      resolvida_por: req.utilizador.id_utilizador
    });
    
    console.log(`‚úÖ [DENUNCIAS] Den√∫ncia de coment√°rio ID: ${id} resolvida com sucesso`);
    
    res.status(200).json({
      success: true,
      message: 'Den√∫ncia resolvida com sucesso',
      data: denuncia
    });
    
  } catch (error) {
    handleError(res, error, 'Erro ao resolver den√∫ncia de coment√°rio');
  }
};

// ========================================
// RESOLVER DEN√öNCIA DE CHAT
// ========================================
const resolverChatDenuncia = async (req, res) => {
  try {
    const { id } = req.params;
    const { acao_tomada } = req.body;
    
    console.log(`üîß [DENUNCIAS] Resolvendo den√∫ncia de chat ID: ${id}`);
    
    if (!acao_tomada || acao_tomada.trim() === '') {
      return res.status(400).json({
        success: false,
        message: 'A a√ß√£o tomada √© obrigat√≥ria'
      });
    }
    
    const denuncia = await ChatDenuncia.findByPk(id);
    
    if (!denuncia) {
      return res.status(404).json({
        success: false,
        message: 'Den√∫ncia n√£o encontrada'
      });
    }
    
    if (denuncia.resolvida) {
      return res.status(400).json({
        success: false,
        message: 'Esta den√∫ncia j√° foi resolvida'
      });
    }
    
    await denuncia.update({
      resolvida: true,
      acao_tomada: acao_tomada.trim(),
      data_resolucao: new Date(),
      resolvida_por: req.utilizador.id_utilizador
    });
    
    console.log(`‚úÖ [DENUNCIAS] Den√∫ncia de chat ID: ${id} resolvida com sucesso`);
    
    res.status(200).json({
      success: true,
      message: 'Den√∫ncia resolvida com sucesso',
      data: denuncia
    });
    
  } catch (error) {
    handleError(res, error, 'Erro ao resolver den√∫ncia de chat');
  }
};

// ========================================
// OCULTAR TEMA
// ========================================
const ocultarForumTema = async (req, res) => {
  try {
    const { id } = req.body;
    
    console.log(`üôà [DENUNCIAS] Ocultando tema ID: ${id}`);
    
    if (!id) {
      return res.status(400).json({
        success: false,
        message: 'ID do tema √© obrigat√≥rio'
      });
    }
    
    const tema = await ForumTema.findByPk(id);
    
    if (!tema) {
      return res.status(404).json({
        success: false,
        message: 'Tema n√£o encontrado'
      });
    }
    
    await tema.update({ oculto: true });
    
    console.log(`‚úÖ [DENUNCIAS] Tema ID: ${id} ocultado com sucesso`);
    
    // Resolver todas as den√∫ncias relacionadas a este tema
    const denunciasAtualizadas = await ForumTemaDenuncia.update(
      { 
        resolvida: true, 
        acao_tomada: 'Conte√∫do ocultado pelo administrador',
        data_resolucao: new Date(),
        resolvida_por: req.utilizador.id_utilizador
      },
      { 
        where: { 
          id_tema: id,
          resolvida: false 
        } 
      }
    );
    
    console.log(`‚úÖ [DENUNCIAS] ${denunciasAtualizadas[0]} den√∫ncias relacionadas foram resolvidas`);
    
    res.status(200).json({
      success: true,
      message: 'Tema ocultado com sucesso',
      denuncias_resolvidas: denunciasAtualizadas[0]
    });
    
  } catch (error) {
    handleError(res, error, 'Erro ao ocultar tema');
  }
};

// ========================================
// OCULTAR COMENT√ÅRIO
// ========================================
const ocultarForumComentario = async (req, res) => {
  try {
    const { id } = req.body;
    
    console.log(`üôà [DENUNCIAS] Ocultando coment√°rio ID: ${id}`);
    
    if (!id) {
      return res.status(400).json({
        success: false,
        message: 'ID do coment√°rio √© obrigat√≥rio'
      });
    }
    
    const comentario = await ForumComentario.findByPk(id);
    
    if (!comentario) {
      return res.status(404).json({
        success: false,
        message: 'Coment√°rio n√£o encontrado'
      });
    }
    
    await comentario.update({ oculto: true });
    
    console.log(`‚úÖ [DENUNCIAS] Coment√°rio ID: ${id} ocultado com sucesso`);
    
    // Resolver todas as den√∫ncias relacionadas a este coment√°rio
    const denunciasAtualizadas = await ForumComentarioDenuncia.update(
      { 
        resolvida: true, 
        acao_tomada: 'Conte√∫do ocultado pelo administrador',
        data_resolucao: new Date(),
        resolvida_por: req.utilizador.id_utilizador
      },
      { 
        where: { 
          id_comentario: id,
          resolvida: false 
        } 
      }
    );
    
    console.log(`‚úÖ [DENUNCIAS] ${denunciasAtualizadas[0]} den√∫ncias relacionadas foram resolvidas`);
    
    res.status(200).json({
      success: true,
      message: 'Coment√°rio ocultado com sucesso',
      denuncias_resolvidas: denunciasAtualizadas[0]
    });
    
  } catch (error) {
    handleError(res, error, 'Erro ao ocultar coment√°rio');
  }
};

// ========================================
// OCULTAR MENSAGEM DE CHAT
// ========================================
const ocultarChatMensagem = async (req, res) => {
  try {
    const { id } = req.body;
    
    console.log(`üôà [DENUNCIAS] Ocultando mensagem de chat ID: ${id}`);
    
    if (!id) {
      return res.status(400).json({
        success: false,
        message: 'ID da mensagem √© obrigat√≥rio'
      });
    }
    
    const mensagem = await ChatMensagem.findByPk(id);
    
    if (!mensagem) {
      return res.status(404).json({
        success: false,
        message: 'Mensagem n√£o encontrada'
      });
    }
    
    await mensagem.update({ 
      texto: '[Mensagem removida pelo administrador]',
      anexo_url: null,
      anexo_nome: null,
      tipo_anexo: null,
      editada: true,
      data_edicao: new Date()
    });
    
    console.log(`‚úÖ [DENUNCIAS] Mensagem de chat ID: ${id} ocultada com sucesso`);
    
    // Resolver todas as den√∫ncias relacionadas a esta mensagem
    const denunciasAtualizadas = await ChatDenuncia.update(
      { 
        resolvida: true, 
        acao_tomada: 'Conte√∫do ocultado pelo administrador',
        data_resolucao: new Date(),
        resolvida_por: req.utilizador.id_utilizador
      },
      { 
        where: { 
          id_mensagem: id,
          resolvida: false 
        } 
      }
    );
    
    console.log(`‚úÖ [DENUNCIAS] ${denunciasAtualizadas[0]} den√∫ncias relacionadas foram resolvidas`);
    
    res.status(200).json({
      success: true,
      message: 'Mensagem ocultada com sucesso',
      denuncias_resolvidas: denunciasAtualizadas[0]
    });
    
  } catch (error) {
    handleError(res, error, 'Erro ao ocultar mensagem de chat');
  }
};

module.exports = {
  getForumTemaDenuncias,
  getForumComentarioDenuncias,
  criarForumTemaDenuncia,
  getUsuarioDenunciasTemas,
  getChatDenuncias,
  resolverForumTemaDenuncia,
  resolverForumComentarioDenuncia,
  resolverChatDenuncia,
  ocultarForumTema,
  ocultarForumComentario,
  ocultarChatMensagem
};